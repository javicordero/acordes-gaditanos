---
import '../styles/global.css';
import { ClientRouter } from 'astro:transitions';
import ContactInit from '../components/utils/ContactInit.astro';
import AnchoPreInit from '../components/utils/AnchoPreInit.astro';
import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';
import CookieBanner from '../components/adsense/CookieBanner.astro';
import CmpTheMoneytizer from '../components/adsense/CmpTheMoneytizer.astro';

interface Props {
  title?: string;
  description?: string;
  image?: string;
  noindex?: boolean;
  keywords?: string;
}

const {
  title = 'Acordes Gaditanos - Acordes y Letras del Carnaval de Cádiz',
  description = 'La mayor colección de acordes de guitarra del Carnaval de Cádiz. Aprende a tocar con tu guitarra todas las presentaciones, pasodobles, tangos, cuplés y popurrís de tus comparsas, chirigotas, coros y cuartetos favoritos.',
  image = '/og-image.png',
  noindex = false,
  keywords = 'carnaval, carnaval de cadiz, COAC, guitarra, acordes de guitarra, comparsa, chirigota, coro, cuartetos, letras carnaval, acordes carnaval',
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const imageURL = new URL(image, Astro.site);
---

<!doctype html>
<html lang='es'>
  <head>
    <meta charset='UTF-8' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0' />
    <link rel='icon' type='image/svg+xml' href='/favicon.svg' />
    <link rel='alternate icon' type='image/x-icon' href='/favicon.ico' />
    <link rel='sitemap' href='/sitemap-index.xml' />
    <link rel='canonical' href={canonicalURL} />

    <!-- Primary Meta Tags -->
    <title>{title}</title>
    <meta name='title' content={title} />
    <meta name='description' content={description} />
    <meta name='keywords' content={keywords} />
    <meta name='author' content='Acordes Gaditanos' />
    <meta name='generator' content={Astro.generator} />
    {noindex && <meta name='robots' content='noindex, nofollow' />}

    <!-- Open Graph / Facebook -->
    <meta property='og:type' content='website' />
    <meta property='og:url' content={canonicalURL} />
    <meta property='og:title' content={title} />
    <meta property='og:description' content={description} />
    <meta property='og:image' content={imageURL} />
    <meta property='og:locale' content='es_ES' />
    <meta property='og:site_name' content='Acordes Gaditanos' />

    <!-- Twitter -->
    <meta name='twitter:card' content='summary_large_image' />
    <meta name='twitter:url' content={canonicalURL} />
    <meta name='twitter:title' content={title} />
    <meta name='twitter:description' content={description} />
    <meta name='twitter:image' content={imageURL} />

    <!-- Structured Data (Schema.org) -->
    <script
      type='application/ld+json'
      set:html={JSON.stringify({
        '@context': 'https://schema.org',
        '@type': 'WebSite',
        name: 'Acordes Gaditanos',
        url: Astro.site,
        description: 'Acordes y letras del Carnaval de Cádiz',
        inLanguage: 'es-ES',
        potentialAction: {
          '@type': 'SearchAction',
          target: `${Astro.site}?q={search_term_string}`,
          'query-input': 'required name=search_term_string',
        },
      })}
    />

    <!-- Cloudflare Web Analytics -->
    {
      !import.meta.env.DEV && !import.meta.env.VITE_DISABLE_CLOUDFLARE && (
        <script
          defer
          src='https://static.cloudflareinsights.com/beacon.min.js'
          data-cf-beacon='{"token": "69575422c7ad4587aad9e1a1b02a5b43", "spa": true}'
        />
      )
    }
    <!-- End Cloudflare Web Analytics -->

    <!-- InMobi Choice. Consent Manager Tag v3.0 (for TCF 2.2) -->
    <script type='text/javascript' async='true'>
      (function () {
        var host = 'www.themoneytizer.com';
        var element = document.createElement('script');
        var firstScript = document.getElementsByTagName('script')[0];
        var url = 'https://cmp.inmobi.com'.concat(
          '/choice/',
          '6Fv0cGNfc_bw8',
          '/',
          host,
          '/choice.js?tag_version=V3'
        );
        var uspTries = 0;
        var uspTriesLimit = 3;
        element.async = true;
        element.type = 'text/javascript';
        element.src = url;

        firstScript.parentNode.insertBefore(element, firstScript);

        function makeStub() {
          var TCF_LOCATOR_NAME = '__tcfapiLocator';
          var queue = [];
          var win = window;
          var cmpFrame;

          function addFrame() {
            var doc = win.document;
            var otherCMP = !!win.frames[TCF_LOCATOR_NAME];

            if (!otherCMP) {
              if (doc.body) {
                var iframe = doc.createElement('iframe');

                iframe.style.cssText = 'display:none';
                iframe.name = TCF_LOCATOR_NAME;
                doc.body.appendChild(iframe);
              } else {
                setTimeout(addFrame, 5);
              }
            }
            return !otherCMP;
          }

          function tcfAPIHandler() {
            var gdprApplies;
            var args = arguments;

            if (!args.length) {
              return queue;
            } else if (args[0] === 'setGdprApplies') {
              if (args.length > 3 && args[2] === 2 && typeof args[3] === 'boolean') {
                gdprApplies = args[3];
                if (typeof args[2] === 'function') {
                  args[2]('set', true);
                }
              }
            } else if (args[0] === 'ping') {
              var retr = {
                gdprApplies: gdprApplies,
                cmpLoaded: false,
                cmpStatus: 'stub',
              };

              if (typeof args[2] === 'function') {
                args[2](retr);
              }
            } else {
              if (args[0] === 'init' && typeof args[3] === 'object') {
                args[3] = Object.assign(args[3], { tag_version: 'V3' });
              }
              queue.push(args);
            }
          }

          function postMessageEventHandler(event) {
            var msgIsString = typeof event.data === 'string';
            var json = {};

            try {
              if (msgIsString) {
                json = JSON.parse(event.data);
              } else {
                json = event.data;
              }
            } catch (ignore) {}

            var payload = json.__tcfapiCall;

            if (payload) {
              window.__tcfapi(
                payload.command,
                payload.version,
                function (retValue, success) {
                  var returnMsg = {
                    __tcfapiReturn: {
                      returnValue: retValue,
                      success: success,
                      callId: payload.callId,
                    },
                  };
                  if (msgIsString) {
                    returnMsg = JSON.stringify(returnMsg);
                  }
                  if (event && event.source && event.source.postMessage) {
                    event.source.postMessage(returnMsg, '*');
                  }
                },
                payload.parameter
              );
            }
          }

          while (win) {
            try {
              if (win.frames[TCF_LOCATOR_NAME]) {
                cmpFrame = win;
                break;
              }
            } catch (ignore) {}

            if (win === window.top) {
              break;
            }
            win = win.parent;
          }
          if (!cmpFrame) {
            addFrame();
            win.__tcfapi = tcfAPIHandler;
            win.addEventListener('message', postMessageEventHandler, false);
          }
        }

        makeStub();

        var uspStubFunction = function () {
          var arg = arguments;
          if (typeof window.__uspapi !== uspStubFunction) {
            setTimeout(function () {
              if (typeof window.__uspapi !== 'undefined') {
                window.__uspapi.apply(window.__uspapi, arg);
              }
            }, 500);
          }
        };

        var checkIfUspIsReady = function () {
          uspTries++;
          if (window.__uspapi === uspStubFunction && uspTries < uspTriesLimit) {
            console.warn('USP is not accessible');
          } else {
            clearInterval(uspInterval);
          }
        };

        if (typeof window.__uspapi === 'undefined') {
          window.__uspapi = uspStubFunction;
          var uspInterval = setInterval(checkIfUspIsReady, 6000);
        }
      })();
    </script>
    <!-- End InMobi Choice. Consent Manager Tag v3.0 (for TCF 2.2) -->

    <!-- <CmpTheMoneytizer /> -->
    <ClientRouter />
  </head>
  <body>
    <Header />
    <slot />
    <Footer />
    <ContactInit />
    <AnchoPreInit />
    <!-- <CookieBanner /> -->
    <!-- 
    <script>
      // // import { hasAcceptedCookies, loadAdsense } from '../utils/cookiesConsent';

      // if (hasAcceptedCookies()) {
      //   loadAdsense();
      // }

      // // Si el usuario acepta en el banner durante la sesión
      // window.addEventListener('ag:cookies-accepted', () => {
      //   if (hasAcceptedCookies()) {
      //     loadAdsense();
      //   }
      // });
    </scrip> -->
  </body>
</html>

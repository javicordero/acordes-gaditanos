---
// GoogleAnalytics.astro — sin Partytown, carga dinámica y tracking SPA solo con consentimiento

type Props = { measurementId: string };
const { measurementId } = Astro.props as Props;
---

<script is:inline data-mid={measurementId}>
  (function () {
    const MID = document.currentScript.dataset.mid;

    if (!document.cookie.includes('cookiesAccepted=true')) {
      console.log('[GA] Sin consentimiento, no cargo GA');
      return;
    }

    console.log('[GA] Consent OK, cargando GA (' + MID + ')');

    // Cargar gtag.js
    const s = document.createElement('script');
    s.async = true;
    s.src = 'https://www.googletagmanager.com/gtag/js?id=' + MID;
    document.head.appendChild(s);

    // Inicializar gtag
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    window.gtag = gtag;

    gtag('js', new Date());
    gtag('config', MID, { send_page_view: false });

    // ---- TRACKING SPA ----
    function sendPageView() {
      if (typeof window.gtag !== 'function') {
        setTimeout(sendPageView, 200);
        return;
      }
      const path = location.pathname + location.search;
      const payload = {
        page_path: path,
        page_location: location.href,
        page_title: document.title,
      };
      console.log('[GA] page_view enviado:', payload);
      window.gtag('event', 'page_view', payload);
    }
    // Primera carga
    setTimeout(sendPageView, 300);
    // Navegaciones SPA del ClientRouter
    const wrapHistory = (method) => {
      const orig = history[method];
      history[method] = function () {
        const res = orig.apply(this, arguments);
        window.dispatchEvent(new Event('acorde:locationchange'));
        return res;
      };
    };
    wrapHistory('pushState');
    wrapHistory('replaceState');
    window.addEventListener('popstate', () =>
      window.dispatchEvent(new Event('acorde:locationchange'))
    );
    let navTimer = null;
    window.addEventListener('acorde:locationchange', () => {
      if (navTimer) clearTimeout(navTimer);
      navTimer = setTimeout(() => {
        // Esperar a que el título y el DOM estén actualizados
        setTimeout(sendPageView, 200);
        navTimer = null;
      }, 100);
    });
  })();
</script>

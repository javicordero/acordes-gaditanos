---
type Props = { measurementId: string };
const props = Astro.props as Props;
const measurementId = props.measurementId;
---

<script type='text/partytown' src={`https://www.googletagmanager.com/gtag/js?id=${measurementId}`}
></script>
<script type='text/partytown' data-ga-measurement-id={measurementId} id='ga-init'>
  const measurementId = document.getElementById('ga-init').getAttribute('data-ga-measurement-id');
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments); // eslint-disable-line
  }
  gtag('js', new Date());
  gtag('config', measurementId);
</script>

<script client:load>
  (() => {
    // Simple, robust SPA page_view sender:
    // - dedup by lastPath (sessionStorage)
    // - small debounce to avoid duplicate sends on very fast navigations
    let lastPath = sessionStorage.getItem('ga_last_path') || '';

    function sendPageView(path) {
      if (!path) path = location.pathname + location.search;
      if (path === lastPath) return;
      lastPath = path;
      try {
        sessionStorage.setItem('ga_last_path', lastPath);
      } catch (e) {}
      const payload = {
        page_path: path,
        page_location: location.href,
        page_title: document.title,
      };
      if (typeof window.gtag === 'function') {
        try {
          window.gtag('event', 'page_view', payload);
        } catch (e) {
          /* ignore */
        }
      } else if (window.dataLayer) {
        try {
          window.dataLayer.push({ event: 'page_view', ...payload });
        } catch (e) {
          /* ignore */
        }
      } else {
        (window.__ga_event_queue = window.__ga_event_queue || []).push(payload);
      }
    }

    // Minimal SPA navigation detection
    const wrapHistory = (method) => {
      try {
        const orig = history[method];
        history[method] = function () {
          const res = orig.apply(this, arguments);
          window.dispatchEvent(new Event('acorde:locationchange'));
          return res;
        };
      } catch (e) {}
    };
    wrapHistory('pushState');
    wrapHistory('replaceState');
    window.addEventListener('popstate', () =>
      window.dispatchEvent(new Event('acorde:locationchange'))
    );

    // Debounce navigation handling (100ms)
    let navTimer = null;
    window.addEventListener('acorde:locationchange', () => {
      if (navTimer) clearTimeout(navTimer);
      navTimer = setTimeout(() => {
        sendPageView();
        navTimer = null;
      }, 100);
    });

    // Flush queued events when gtag is available
    const flushInterval = setInterval(() => {
      if (typeof window.gtag === 'function' && Array.isArray(window.__ga_event_queue)) {
        try {
          window.__ga_event_queue.forEach((p) => window.gtag('event', 'page_view', p));
        } catch (e) {}
        window.__ga_event_queue = [];
        clearInterval(flushInterval);
      }
    }, 500);

    // Initial page_view (small delay to allow title/popstate settle)
    setTimeout(() => sendPageView(), 60);
  })();
</script>

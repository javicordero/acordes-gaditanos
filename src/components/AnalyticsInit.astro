---
const GA_ID = import.meta.env.PUBLIC_GA_ID;
const MODE = import.meta.env.MODE;
---

{GA_ID && MODE !== 'development' ? (
  <>
    <!-- Google Analytics (gtag.js) -->
    <script async src={`https://www.googletagmanager.com/gtag/js?id=${GA_ID}`}></script>

    <script>
      {`window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);} 
gtag('js', new Date());
gtag('config','${GA_ID}', { send_page_view: false });`}
    </script>

    <script type="module" client:load>
      (function () {
        if (!window.gtag) return;
        const GA_ID = '${GA_ID}';

        function sendPageView(url) {
          try {
            window.gtag('event', 'page_view', { page_path: url });
            console.debug('[AnalyticsInit] page_view', url);
          } catch (e) {}
        }

        // initial page view
        sendPageView(location.pathname + location.search);

        // listen for SPA navigation events (project already emits acorde:locationchange)
        window.addEventListener('acorde:locationchange', () => setTimeout(() => sendPageView(location.pathname + location.search), 50));
        window.addEventListener('popstate', () => setTimeout(() => sendPageView(location.pathname + location.search), 50));

        // patch history methods if not patched
        if (!window.__ga_history_patched) {
          try {
            const origPush = history.pushState;
            const origReplace = history.replaceState;
            history.pushState = function () {
              const res = origPush.apply(this, arguments);
              window.dispatchEvent(new Event('acorde:locationchange'));
              return res;
            };
            history.replaceState = function () {
              const res = origReplace.apply(this, arguments);
              window.dispatchEvent(new Event('acorde:locationchange'));
              return res;
            };
            window.__ga_history_patched = true;
          } catch (e) {}
        }

        // generic event delegator: elements with data-ga-event will be tracked
        document.addEventListener('click', (ev) => {
          const el = ev.target.closest && ev.target.closest('[data-ga-event]');
          if (!el) return;
          const eventName = el.dataset.gaEvent;
          let params = {};
          try { params = el.dataset.gaParams ? JSON.parse(el.dataset.gaParams) : {}; } catch(e){}
          try { window.gtag('event', eventName, params); } catch (e) {}
        }, true);
      })();
    </script>
  </>
) : null}

---
import { getCollection, render } from 'astro:content';
import AcordeCard from '../../components/acorde-card.astro';
import YoutubeCard from '../../components/right-column/youtube-card.astro';
import SitiosDeInteresCard from '../../components/right-column/sitios-de-interes-card.astro';
import Apoyar from '../../components/right-column/apoyar.astro';
import ApareceAqui from '../../components/right-column/aparece-aqui.astro';
import Layout from '../../layouts/Layout.astro';
import MusicCompositionSchema from '../../components/utils/MusicCompositionSchema.astro';

export async function getStaticPaths() {
  const acordes = await getCollection('acordes');
  return acordes.map((acorde: { slug: any }) => ({
    params: { id: acorde.slug },
    props: { acorde },
  }));
}

const { acorde } = Astro.props;
const { data, slug } = acorde;
const {
  pieza,
  agrupacion,
  musica,
  img,
  year,
  letra,
  video,
  cover,
  coverAuthor,
  cejilla,
  modalidad,
} = data;

// Generar texto de autoría
const autores = musica === letra ? `de ${musica}` : `de ${letra} y ${musica}`;

// Generar descripción completa
const description = `Acordes ${pieza} ${agrupacion} ${modalidad} ${autores}. La mayor colección de acordes de guitarra del Carnaval de Cádiz. Aprende a tocar con tu guitarra todas las presentaciones, pasodobles, tangos, cuplés y popurrís de tus comparsas, chirigotas, coros y cuartetos favoritos.`;

// Generar keywords específicas
const keywords = `carnaval, carnaval de cadiz, COAC, guitarra, acordes de guitarra, comparsa, chirigota, coro, cuartetos, letras carnaval, acordes carnaval, ${agrupacion}, ${letra}, ${musica}`;

// Generar URL canónica
const canonicalURL = new URL(Astro.url.pathname, Astro.site).toString();
---

<Layout
  title={`Acordes ${pieza} ${agrupacion}`}
  description={description}
  keywords={keywords}
  image={img}>
  <MusicCompositionSchema
    pieza={pieza}
    agrupacion={agrupacion}
    musica={musica}
    letra={letra}
    year={year}
    modalidad={modalidad}
    url={canonicalURL}
  />

  <div class='main-container container-layout'>
    <AcordeCard acorde={acorde} />

    <div class='right-column'>
      <YoutubeCard
        link={video}
        iframeTitle={`Video oficial de ${pieza} - ${agrupacion} - Carnaval de Cádiz ${year}`}
      />

      {
        cover && (
          <YoutubeCard
            link={cover}
            title={coverAuthor ? `Cover de ${coverAuthor}` : 'Cover'}
            iframeTitle={
              coverAuthor ? `Cover por ${coverAuthor}` : `Cover de ${pieza} - ${agrupacion}`
            }
          />
        )
      }
      {!cover && <ApareceAqui />}

      <Apoyar />

      <SitiosDeInteresCard />
    </div>
  </div>
</Layout>

<style>
  .main-container {
    display: flex;
    row-gap: 16px;
    column-gap: 16px;
  }

  .right-column {
    display: flex;
    flex-direction: column;
    gap: 16px;
    /* La columna derecha crecerá para rellenar el espacio restante dentro del contenedor hasta un máximo razonable */
    flex: 1 1 clamp(220px, 22vw, 380px);
    min-width: 0;
  }

  /* Mantener la card izquierda con su anchura natural (el componente controla su propio max-width)
     y dejar que la columna derecha tome el espacio sobrante */
  .main-container > .acordes-container {
    flex: 0 0 auto;
    min-width: 0;
  }

  @media (max-width: 780px) {
    .main-container {
      column-gap: 16px;
    }
  }

  /* Para resoluciones intermedias (tablet → pequeño desktop) hacemos la card más estrecha */
  @media (min-width: 640px) and (max-width: 1024px) {
    .main-container > .acordes-container {
      /* Reducir anchura y fijar base para que no ocupe tanto espacio */
      max-width: 576px;
      min-width: 0;
    }
  }

  @media (max-width: 640px) {
    .main-container {
      flex-direction: column;
    }
  }

  @media (min-width: 900px) {
    .right-column {
      flex: 1 1 clamp(260px, 20vw, 480px);
    }
  }
</style>

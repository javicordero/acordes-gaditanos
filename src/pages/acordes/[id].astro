---
import { getCollection, render } from 'astro:content';
import AcordeCard from '../../components/AcordeCard.astro';
import YoutubeCard from '../../components/right-column/YoutubeCard.astro';
import SitiosDeInteresCard from '../../components/right-column/SitiosDeInteresCard.astro';
import ApareceAqui from '../../components/right-column/ApareceAqui.astro';
import Layout from '../../layouts/Layout.astro';
import MusicCompositionSchema from '../../components/utils/MusicCompositionSchema.astro';
import AnunciosGuitarra from '../../components/right-column/anuncios/AnunciosGuitarra.astro';
import AnunciosLibros from '../../components/right-column/anuncios/AnunciosLibros.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import Apoyar from '../../components/right-column/Apoyar.astro';
import SigueTocando from '../../components/right-column/SigueTocando.astro';
import AcordesRecomendados from '../../components/right-column/AcordesRecomendados.astro';

export async function getStaticPaths() {
  const acordes = await getCollection('acordes');
  return acordes.map((acorde: { slug: any }) => ({
    params: { id: acorde.slug },
    props: { acorde },
  }));
}

const { acorde } = Astro.props;
const { data, slug } = acorde;
const {
  pieza,
  agrupacion,
  musica,
  img,
  year,
  letra,
  video,
  cover,
  autorCover,
  cejilla,
  modalidad,
  fraseClave,
} = data;

// Obtener acordes recomendados
const todosLosAcordes = await getCollection('acordes');
const acordesRecomendados = todosLosAcordes
  .filter((a) => a.data.recomendada === true && a.slug !== slug)
  .sort(() => Math.random() - 0.5) // Ordenar aleatoriamente
  .slice(0, 6); // Limitar a 6 recomendaciones

// Generar texto de autoría
const autores = musica === letra ? `de ${musica}` : `de ${letra} y ${musica}`;

// Generar descripción completa
const description = `Acordes ${pieza} ${agrupacion} ${autores}, Carnaval ${year}, ${fraseClave ? fraseClave + ', ' : ''}La mayor colección de acordes de guitarra del Carnaval de Cádiz. Aprende a tocar con tu guitarra todas las presentaciones, pasodobles, tangos, cuplés y popurrís de tus comparsas, chirigotas, coros y cuartetos favoritos.`;

// Generar keywords específicas
const keywords = `carnaval, carnaval de cadiz, COAC, guitarra, acordes de guitarra, comparsa, chirigota, coro, cuartetos, letras carnaval, acordes carnaval, tanguillo ${agrupacion}, ${letra}, ${musica}, ${pieza}, ${year}${fraseClave ? ', ' + fraseClave : ''}`;

// Generar URL canónica
const canonicalURL = new URL(Astro.url.pathname, Astro.site).toString();

// Imagen absoluta para OG / Twitter / Schema
const imageUrl = img
  ? new URL(img, Astro.site).toString()
  : new URL('/og-default.jpg', Astro.site).toString();
---

<Layout
  title={`Acordes ${pieza} ${agrupacion} - Carnaval ${year} - Acordes Gaditanos`}
  description={description}
  keywords={keywords}
  image={img}>
  <MusicCompositionSchema
    pieza={pieza}
    agrupacion={agrupacion}
    musica={musica}
    letra={letra}
    year={year}
    modalidad={modalidad}
    url={canonicalURL}
    image={imageUrl}
  />

  <Breadcrumb
    year={year}
    agrupacion={agrupacion}
    agrupacionSlug={data.agrupacionSlug}
    pieza={pieza}
  />

  <h1 class='seo-title'>
    Acordes {pieza}
    {agrupacion} - Carnaval {year} - {musica} - Acordes Gaditanos
  </h1>

  <p class='seo-text'>
    Estos son los acordes de guitarra de {pieza} de {agrupacion} de
    {musica}, del Carnaval de Cádiz {year}.
  </p>

  <div class='main-container container-layout'>
    <AcordeCard acorde={acorde} />

    <div class='right-column'>
      <div class='ezoic-slot desktop-only' id='ezoic-pub-ad-placeholder-118'></div>
      <YoutubeCard
        link={video}
        iframeTitle={`Video oficial de ${pieza} - ${agrupacion} - Carnaval de Cádiz ${year}`}
        class='video-oficial'
      />

      {
        cover && (
          <YoutubeCard
            link={cover}
            title={`${autorCover} a la guitarra`}
            iframeTitle={`${autorCover} a la guitarra`}
            class='video-cover'
          />
        )
      }
      {!cover && <ApareceAqui class='aparece-aqui' />}

      <Apoyar class='apoyar' />

      <div class='ezoic-slot desktop-only' id='ezoic-pub-ad-placeholder-119'></div>

      <SigueTocando
        class='sigue-tocando'
        agrupacion={agrupacion}
        year={year}
        letra={letra}
        musica={musica}
        letraSlug={data.letraSlug}
        musicaSlug={data.musicaSlug}
        agrupacionSlug={data.agrupacionSlug}
      />

      <AcordesRecomendados class='recomendados' recomendadas={acordesRecomendados} />

      <div class='ezoic-slot desktop-only' id='ezoic-pub-ad-placeholder-120'></div>
      <div class='ezoic-slot desktop-only' id='ezoic-pub-ad-placeholder-121'></div>

      <!-- <SitiosDeInteresCard class='sitios-interes' /> -->
    </div>

    <style>
      .seo-title,
      .seo-text {
        position: absolute;
        left: -9999px;
      }

      .main-container {
        display: flex;
        row-gap: 16px;
        column-gap: 32px;
      }

      .right-column {
        display: flex;
        flex-direction: column;
        gap: 16px;
        /* La columna derecha crecerá para rellenar el espacio restante dentro del contenedor hasta un máximo razonable */
        flex: 1 1 clamp(220px, 22vw, 380px);
      }

      /* Mantener la card izquierda con su anchura natural (el componente controla su propio max-width)
     y dejar que la columna derecha tome el espacio sobrante */
      .main-container > :global(.acorde-card) {
        flex: 0 0 auto;
        min-width: 0;
      }

      @media (max-width: 780px) {
        .main-container {
          column-gap: 16px;
        }
      }

      /* Para resoluciones intermedias (tablet → pequeño desktop) hacemos la card más estrecha */
      @media (min-width: 640px) and (max-width: 1024px) {
        .main-container > :global(.acorde-card) {
          /* Reducir anchura y fijar base para que no ocupe tanto espacio */
          max-width: 576px;
          min-width: 0;
          flex: 1 1 576px;
        }
      }

      @media (max-width: 640px) {
        .main-container {
          flex-direction: column;
        }

        /* Reordenar visualmente en móvil: SigueTocando primero */
        .right-column > :global(.sigue-tocando) {
          order: -2;
        }

        .right-column > :global(.recomendados) {
          order: -1;
        }

        /* Apoyar segundo */
        .right-column > :global(.apoyar) {
          order: 0;
        }

        /* El resto mantiene orden natural (order: 0 por defecto) */
        .right-column > :global(.video-oficial) {
          order: 2;
        }

        .right-column > :global(.video-cover),
        .right-column > :global(.aparece-aqui) {
          order: 1;
        }
      }

      @media (min-width: 900px) {
        .right-column {
          flex: 1 1 clamp(260px, 20vw, 480px);
        }
      }
    </style>
  </div></Layout
>

---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import YearCard from '../../components/YearCard.astro';

import Breadcrumb from '../../components/Breadcrumb.astro';

export async function getStaticPaths() {
  const acordes = await getCollection('acordes');
  // Recopilar todas las agrupaciones únicas
  const agrupacionesMap = new Map();
  acordes.forEach((acorde) => {
    if (acorde.data.agrupacion && acorde.data.agrupacionSlug) {
      if (!agrupacionesMap.has(acorde.data.agrupacionSlug)) {
        agrupacionesMap.set(acorde.data.agrupacionSlug, {
          nombre: acorde.data.agrupacion,
          acordes: [],
        });
      }
      agrupacionesMap.get(acorde.data.agrupacionSlug).acordes.push(acorde);
    }
  });
  return Array.from(agrupacionesMap.entries()).map(([slug, data]) => ({
    params: { agrupacionSlug: slug },
    props: {
      agrupacionName: data.nombre,
      acordes: data.acordes,
    },
  }));
}

const { agrupacionName, acordes } = Astro.props;

// Ordenar acordes por año descendente y fecha
function parseSpanishDate(str) {
  const [d, m, y] = str.split(/[-/]/).map(Number);
  return new Date(y, m - 1, d);
}

const acordesOrdenados = acordes.sort((a, b) => {
  const yearA = Number(a.data.year);
  const yearB = Number(b.data.year);
  if (yearA !== yearB) {
    return yearB - yearA;
  }
  const dateA = parseSpanishDate(a.data.date);
  const dateB = parseSpanishDate(b.data.date);
  return dateB.getTime() - dateA.getTime();
});

const title = `${agrupacionName} - Acordes y Letras del Carnaval de Cádiz`;
const description = `Todos los acordes y letras de la agrupación ${agrupacionName} del Carnaval de Cádiz.`;
---

<Layout title={title} description={description}>
  <Breadcrumb
    year={acordesOrdenados[0]?.data.year}
    agrupacion={agrupacionName}
    agrupacionSlug={acordes[0]?.data.agrupacionSlug}
  />
  <div class='main-container container-layout'>
    <article>
      <YearCard year={agrupacionName} acordes={acordesOrdenados} />
    </article>
  </div>
</Layout>

<style>
  .main-container {
    display: flex;
    flex-direction: column;
    gap: var(--main-container-gap);
  }
  @media (max-width: 640px) {
    .main-container {
      gap: var(--main-container-gap-sm);
    }
  }
</style>

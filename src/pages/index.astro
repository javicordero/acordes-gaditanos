---
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import YearCard from '../components/year-card.astro';
import Footer from '../components/layout/footer.astro';
import Header from '../components/layout/header.astro';

function parseSpanishDate(str: string) {
  const [d, m, y] = str.split(/[-/]/).map(Number);
  return new Date(y, m - 1, d); // Date(year, monthIndex, day)
}
let acordes = await getCollection('acordes');

acordes = acordes.sort((a, b) => {
  const yearA = a.data.year;
  const yearB = b.data.year;

  // Primero ordenamos por año descendente
  if (yearA !== yearB) {
    return yearB - yearA;
  }

  // Luego por fecha española descendente
  const dateA = parseSpanishDate(a.data.date);
  const dateB = parseSpanishDate(b.data.date);

  return dateB.getTime() - dateA.getTime();
});

// Agrupar por año (se mantiene el orden interno ya ordenado)
const grouped = acordes.reduce((acc: Record<string, any[]>, item) => {
  const y = String(item.data.year ?? 'Sin año');
  if (!acc[y]) acc[y] = [];
  acc[y].push(item);
  return acc;
}, {});

// Obtener años ordenados descendente (numéricamente cuando sea posible)
const years = Object.keys(grouped).sort((a, b) => {
  const na = Number(a);
  const nb = Number(b);
  if (isNaN(na) || isNaN(nb)) return b.localeCompare(a);
  return nb - na;
});
---

<Layout
  title='Acordes Gaditanos - Acordes y Letras del Carnaval de Cádiz'
  description='La mayor colección de acordes y letras del Carnaval de Cádiz. Encuentra acordes de chirigotas, comparsas, cuartetos y coros para tocar con tu guitarra.'>
  <div></div>
  <Header />
  <div class='main-container container-layout'>
    {
      years.map((year) => {
        const acordes = grouped[year];
        return <YearCard year={year} acordes={acordes} key={year} />;
      })
    }
  </div>
  <Footer />
</Layout>

<style>
  .main-container {
    display: flex;
    flex-direction: column;
    gap: var(--main-container-gap);
  }

  @media (max-width: 640px) {
    .main-container {
      gap: var(--main-container-gap-sm);
    }
  }
</style>

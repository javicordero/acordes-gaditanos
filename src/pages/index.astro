---
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import Card from '../components/card.astro';
import Header from '../components/header.astro';
import Footer from '../components/footer.astro';

function parseSpanishDate(str: string) {
  const [d, m, y] = str.split(/[-/]/).map(Number);
  return new Date(y, m - 1, d); // Date(year, monthIndex, day)
}
let acordes = await getCollection('acordes');

acordes = acordes.sort((a, b) => {
  const yearA = a.data.year;
  const yearB = b.data.year;

  // Primero ordenamos por año descendente
  if (yearA !== yearB) {
    return yearB - yearA;
  }

  // Luego por fecha española descendente
  const dateA = parseSpanishDate(a.data.date);
  const dateB = parseSpanishDate(b.data.date);

  return dateB.getTime() - dateA.getTime();
});

// Agrupar por año (se mantiene el orden interno ya ordenado)
const grouped = acordes.reduce((acc: Record<string, any[]>, item) => {
  const y = String(item.data.year ?? 'Sin año');
  if (!acc[y]) acc[y] = [];
  acc[y].push(item);
  return acc;
}, {});

// Obtener años ordenados descendente (numéricamente cuando sea posible)
const years = Object.keys(grouped).sort((a, b) => {
  const na = Number(a);
  const nb = Number(b);
  if (isNaN(na) || isNaN(nb)) return b.localeCompare(a);
  return nb - na;
});
---

<Layout title='Acordes Gaditanos' description='Colección de acordes de piezas gaditanas'>
  <div></div>
  <Header />
  <main class='main-container container-layout'>
    {
      years.map((year) => {
        const items = grouped[year];
        return (
          <section class='year-group' key={year}>
            <header>
              <h2 class='year-header'>{year}</h2>
            </header>
            <div class='section'>
              {items.map((acorde: { slug: any; data: any }) => {
                const { slug, data } = acorde;
                const { pieza, agrupacion, musica, letra, img, year: y } = data;

                return (
                  <Card
                    pieza={pieza}
                    agrupacion={agrupacion}
                    musica={musica}
                    letra={letra}
                    img={img}
                    year={y}
                    slug={slug}
                  />
                );
              })}
            </div>
          </section>
        );
      })
    }
  </main>
  <Footer />
</Layout>

<style>
  .main-container {
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .year-group {
    display: flex;
    flex-direction: column;
    gap: 32px;
  }

  .year-group:not(:first-of-type) {
    /* border-top: 1px solid var(--secondary-color); */
    /* padding-top: 8px; */
  }

  .year-group header {
    /* text-align: end; */
    padding: 0 8px;
  }

  .year-group header h2 {
    color: var(--secondary-color);
  }

  .section {
    display: grid;
    row-gap: 40px;
    /* por defecto 2 columnas en pantallas pequeñas */
    grid-template-columns: repeat(2, 1fr);
    align-items: start;
  }

  /* tablet: 3 columnas intermedias */
  @media (min-width: 640px) {
    .section {
      grid-template-columns: repeat(3, 1fr);
      column-gap: 12px;
    }
  }

  @media (min-width: 1024px) {
    .section {
      column-gap: 16px;
    }
  }

  /* pantallas grandes: 4 columnas */
  @media (min-width: 1440px) {
    .section {
      grid-template-columns: repeat(4, 1fr);
      column-gap: 16px;
    }
  }

  @media (max-width: 640px) {
    .year-group {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .section {
      row-gap: 24px;
      column-gap: 4px;
    }
  }
</style>
